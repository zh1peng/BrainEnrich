<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Computation on HPC with slurm â€¢ BrainEnrich</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Computation on HPC with slurm">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BrainEnrich</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/annoData_demo.html">Preparison of gene sets (annoData)</a></li>
    <li><a class="dropdown-item" href="../articles/brainenrich_demo.html">Group-level Enrichment Analysis (brainenrich)</a></li>
    <li><a class="dropdown-item" href="../articles/brainscore_demo.html">Individual-level enrichment analysis (brainscore/brainscore.lm_test)</a></li>
    <li><a class="dropdown-item" href="../articles/brainscore.simulate_demo.html">Simulation analysis (brainscore.simulate)</a></li>
    <li><a class="dropdown-item" href="../articles/hpc_demo.html">Computation on HPC with slurm</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="hpc_demo_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Computation on HPC with slurm</h1>
            
      

      <div class="d-none name"><code>hpc_demo.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Here, we documented how to precompute null gene set scores and run simulations on high-performance computing (HPC) systems using Slurm. By leveraging job splitting and parallel processing, we provide step-by-step instructions for running distributed permutation tests and simulations across multiple nodes on an HPC cluster.</p>
<p>Note: This is intended for users who have access to an HPC system and want to perform large-scale analyses efficiently.</p>
</div>
<div class="section level2">
<h2 id="installation-of-the-brainenrich-package">1. Installation of the BrainEnrich package<a class="anchor" aria-label="anchor" href="#installation-of-the-brainenrich-package"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install remotes if you haven't already</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"remotes"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"DOSE"</span><span class="op">)</span></span>
<span><span class="co"># Install brainEnrich from GitHub</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"zh1peng/BrainEnrich"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="download-gene_data-and-annodata-to-the-package">2. Download gene_data and annoData to the package<a class="anchor" aria-label="anchor" href="#download-gene_data-and-annodata-to-the-package"></a>
</h2>
<p>We only need to do this once, and they will be available for all the nodes in the HPC. If you download them during the slurm job, it might cause the job to fail due to the sequential download of the data. The first node is trying to download the data, and the other nodes are trying to access the data that is not yet downloaded.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zh1peng.github.io/BrainEnrich/" class="external-link">BrainEnrich</a></span><span class="op">)</span></span>
<span><span class="va">gene_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_geneExp.html">get_geneExp</a></span><span class="op">(</span>atlas <span class="op">=</span> <span class="st">"desikan"</span>, rdonor <span class="op">=</span> <span class="st">"r0.4"</span>, hem <span class="op">=</span> <span class="st">"L"</span><span class="op">)</span></span>
<span><span class="va">annoData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_annoData.html">get_annoData</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"SynGO"</span><span class="op">)</span></span>
<span><span class="va">annoData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_annoData.html">get_annoData</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"GO_MF"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="use-job_splitter-a-generic-function-to-split-jobs-to-do-brainscore">3. use job_splitter (a generic function to split jobs) to do brainscore<a class="anchor" aria-label="anchor" href="#use-job_splitter-a-generic-function-to-split-jobs-to-do-brainscore"></a>
</h2>
<div class="section level3">
<h3 id="prepare-the-script-for-the-job_splitter-function">3.1. Prepare the script for the job_splitter function<a class="anchor" aria-label="anchor" href="#prepare-the-script-for-the-job_splitter-function"></a>
</h3>
<p>Here, we will prepare a script for distributed computing environments, allowing large-scale permutation tests to be split across multiple compute nodes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># brainscore_vacc.R</span></span>
<span><span class="co"># Rscript brainscore_vacc.R &lt;job_id&gt; &lt;n_iter_per_job&gt; &lt;iter_total&gt; &lt;cor_method&gt; &lt;aggre_method&gt; &lt;null_model&gt; &lt;gs_type&gt; &lt;minGSSize&gt; &lt;maxGSSize&gt;</span></span>
<span><span class="co"># Get command-line arguments</span></span>
<span><span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span>trailingOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">job_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">n_iter_per_job</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">iter_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">cor_method</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">aggre_method</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">null_model</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="va">gs_type</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span></span>
<span><span class="va">minGSSize</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">maxGSSize</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load your R package and any required libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zh1peng.github.io/BrainEnrich/" class="external-link">BrainEnrich</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set other parameters</span></span>
<span><span class="va">output_dir_base</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/precomputed_brainscore"</span></span>
<span><span class="va">data_path</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/data"</span></span>
<span></span>
<span><span class="co"># Load hcp brain_data</span></span>
<span><span class="va">brain_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"hcp_brain_data_dk_lh.RDS"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Load additional necessary data</span></span>
<span><span class="va">gene_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_geneExp.html">get_geneExp</a></span><span class="op">(</span>atlas <span class="op">=</span> <span class="st">"desikan"</span>, rdonor <span class="op">=</span> <span class="st">"r0.4"</span>, hem <span class="op">=</span> <span class="st">"L"</span><span class="op">)</span></span>
<span><span class="va">annoData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_annoData.html">get_annoData</a></span><span class="op">(</span>type <span class="op">=</span> <span class="va">gs_type</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">null_model</span> <span class="op">==</span> <span class="st">"spin_brain"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subset_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>perm_id <span class="op">=</span> <span class="va">perm_id_dk_lh_5000</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">subset_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Update the output directory based on the input parameters</span></span>
<span><span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>  <span class="va">output_dir_base</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>    <span class="st">"%s_%s_%s_%s_%d_%d_%d"</span>,</span>
<span>    <span class="va">gs_type</span>,</span>
<span>    <span class="va">null_model</span>,</span>
<span>    <span class="va">cor_method</span>,</span>
<span>    <span class="va">aggre_method</span>,</span>
<span>    <span class="va">minGSSize</span>,</span>
<span>    <span class="va">maxGSSize</span>,</span>
<span>    <span class="va">iter_total</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Call the job_splitter function to split the jobs and run the brainscore function</span></span>
<span><span class="fu"><a href="../reference/job_splitter.html">job_splitter</a></span><span class="op">(</span></span>
<span>  job_id <span class="op">=</span> <span class="va">job_id</span>,</span>
<span>  n_iter_per_job <span class="op">=</span> <span class="va">n_iter_per_job</span>,</span>
<span>  iter_total <span class="op">=</span> <span class="va">iter_total</span>,</span>
<span>  prefix <span class="op">=</span> <span class="st">"res_job_"</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="va">output_dir</span>,</span>
<span>  FUN <span class="op">=</span> <span class="va">brainscore</span>,</span>
<span>  subset_vars <span class="op">=</span> <span class="va">subset_vars</span>, <span class="co"># perm_id will be subsetted when spliting the jobs for spin_brain mode</span></span>
<span>  subset_total_var <span class="op">=</span> <span class="st">"n_perm"</span>,</span>
<span>  brain_data <span class="op">=</span> <span class="va">brain_data</span>,</span>
<span>  gene_data <span class="op">=</span> <span class="va">gene_data</span>,</span>
<span>  annoData <span class="op">=</span> <span class="va">annoData</span>,</span>
<span>  cor_method <span class="op">=</span> <span class="va">cor_method</span>,</span>
<span>  aggre_method <span class="op">=</span> <span class="va">aggre_method</span>,</span>
<span>  null_model <span class="op">=</span> <span class="va">null_model</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  minGSSize <span class="op">=</span> <span class="va">minGSSize</span>,</span>
<span>  maxGSSize <span class="op">=</span> <span class="va">maxGSSize</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prepare-the-slurm-job-file">3.2. Prepare the slurm job file<a class="anchor" aria-label="anchor" href="#prepare-the-slurm-job-file"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co">#!/bin/bash</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="co">#SBATCH --job-name=gsScore              # Job name</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="co">#SBATCH --output=gsScore.out  </span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="co">#SBATCH --error=gsScore.err   </span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="co">#SBATCH --time=10:00:00                 # Time limit hrs:min:sec</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="co">#SBATCH --nodes=1                       # Number of nodes</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="co">#SBATCH --ntasks=1                      # Number of tasks</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="co">#SBATCH --mem=16G                       # Memory per node</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a><span class="co">#SBATCH --array=1-1000                  # Array range (adjust based on perm_total / n_perm_per_job)</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="co"># Define variables for the script</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a><span class="va">n_iter_per_job=</span>5          # <span class="ex">Number</span> of permutations per job (adjust as needed)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a><span class="va">iter_total=</span>5000           # <span class="ex">Total</span> number of permutations</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a><span class="va">cor_method=</span><span class="st">"pearson"</span>      # <span class="ex">Correlation</span> method</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a><span class="va">aggre_method=</span><span class="st">"mean"</span>       # <span class="ex">Aggregation</span> method</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a><span class="va">minGSSize=</span>20              # <span class="ex">Minimum</span> gene set size</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a><span class="va">maxGSSize=</span>200             # <span class="ex">Maximum</span> gene set size</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a><span class="co"># Define an array of null models to loop through</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a><span class="va">null_models=(</span><span class="st">"resample_gene"</span> <span class="st">"spin_brain"</span><span class="va">)</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a><span class="va">gs_types=(</span><span class="st">"SynGO"</span> <span class="st">"GO_MF"</span><span class="va">)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a><span class="co"># Change directory to where your R script is located</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a><span class="bu">cd</span> /gpfs1/home/z/c/zcao4/BrainEnrich</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a><span class="kw">for</span> <span class="ex">gs_type</span> in <span class="st">"</span><span class="va">${gs_types[@]}</span><span class="st">"</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a>  <span class="kw">for</span> <span class="ex">null_model</span> in <span class="st">"</span><span class="va">${null_models[@]}</span><span class="st">"</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>    <span class="ex">Rscript</span> --vanilla run_brainscore_hpc.R <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="va">$n_iter_per_job</span> <span class="va">$iter_total</span> <span class="va">$cor_method</span> <span class="va">$aggre_method</span> <span class="va">$null_model</span> <span class="va">$gs_type</span> <span class="va">$minGSSize</span> <span class="va">$maxGSSize</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>  <span class="kw">done</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a><span class="kw">done</span></span></code></pre></div>
<p>Note: when running job_cat, it will detect if there are rds files missing in the output_dir if there are some job failed, do this to rerun the failed jobs Here is how to rerun the failed jobs:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="co">#!/bin/bash</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="co">#SBATCH --job-name=gsScore_retry       # Job name</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="co">#SBATCH --output=gsScore_retry_%A_%a.out     # Standard output log</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="co">#SBATCH --error=gsScore_retry_%A_%a.err      # Standard error log</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="co">#SBATCH --time=10:00:00                # Time limit hrs:min:sec</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a><span class="co">#SBATCH --nodes=1                      # Number of nodes</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="co">#SBATCH --ntasks=1                     # Number of tasks</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a><span class="co">#SBATCH --mem=16G                      # Memory per node</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="co">#SBATCH --array=1-5                    # Array range to cover all indices</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a><span class="co"># Define variables for the script</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a><span class="va">n_iter_per_job=</span>5          # <span class="ex">Number</span> of permutations per job (adjust as needed)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a><span class="va">iter_total=</span>5000           # <span class="ex">Total</span> number of permutations</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a><span class="va">cor_method=</span><span class="st">"pearson"</span>      # <span class="ex">Correlation</span> method</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a><span class="va">aggre_method=</span><span class="st">"mean"</span>       # <span class="ex">Aggregation</span> method</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a><span class="va">minGSSize=</span>20              # <span class="ex">Minimum</span> gene set size</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a><span class="va">maxGSSize=</span>200             # <span class="ex">Maximum</span> gene set size</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a><span class="va">null_model=</span><span class="st">"resample_gene"</span> # <span class="ex">Null</span> model</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a><span class="va">gs_type=</span><span class="st">"GO_MF"</span>           # <span class="ex">Gene</span> set type</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a><span class="co"># Define the list of missing job IDs</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a><span class="va">job_id_list=(</span>70 74 75 76 79<span class="va">)</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true"></a><span class="co"># Get the specific job ID based on the SLURM_ARRAY_TASK_ID</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true"></a><span class="va">job_id=${job_id_list[$SLURM_ARRAY_TASK_ID-1]}</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true"></a><span class="co"># Change directory to where your R script is located</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true"></a><span class="bu">cd</span> /gpfs1/home/z/c/zcao4/BrainEnrich</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true"></a><span class="co"># Run the R script for the specific jobs</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true"></a><span class="ex">Rscript</span> --vanilla run_brainscore_hpc.R <span class="va">$job_id</span> <span class="va">$n_iter_per_job</span> <span class="va">$iter_total</span> <span class="va">$cor_method</span> <span class="va">$aggre_method</span> <span class="va">$null_model</span> <span class="va">$gs_type</span> <span class="va">$minGSSize</span> <span class="va">$maxGSSize</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="use-job_cat-to-collect-the-brainscore-results-from-jobs">3.3. Use job_cat to collect the brainscore results from jobs<a class="anchor" aria-label="anchor" href="#use-job_cat-to-collect-the-brainscore-results-from-jobs"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zh1peng.github.io/BrainEnrich/" class="external-link">BrainEnrich</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the base output directory</span></span>
<span><span class="va">input_dir_base</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/precomputed_brainscore"</span></span>
<span></span>
<span><span class="co"># Define the parameters of the analysis</span></span>
<span><span class="va">n_iter_per_job</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># Number of iterations per job (adjust as needed)</span></span>
<span><span class="va">iter_total</span> <span class="op">&lt;-</span> <span class="fl">5000</span> <span class="co"># Total number of iterations</span></span>
<span><span class="va">cor_method</span> <span class="op">&lt;-</span> <span class="st">"pearson"</span> <span class="co"># Correlation method</span></span>
<span><span class="va">aggre_method</span> <span class="op">&lt;-</span> <span class="st">"mean"</span> <span class="co"># Aggregation method</span></span>
<span><span class="va">minGSSize</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># Minimum gene set size</span></span>
<span><span class="va">maxGSSize</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># Maximum gene set size</span></span>
<span></span>
<span><span class="co"># Define an array of null models and gene set types to loop through</span></span>
<span><span class="va">null_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"resample_gene"</span>, <span class="st">"spin_brain"</span><span class="op">)</span></span>
<span><span class="va">gs_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SynGO"</span>, <span class="st">"GO_MF"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through each combination of null model and gene set type</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">null_model</span> <span class="kw">in</span> <span class="va">null_models</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">gs_type</span> <span class="kw">in</span> <span class="va">gs_types</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Construct the folder name based on the parameters</span></span>
<span>    <span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"%s_%s_%s_%s_%d_%d_%d"</span>,</span>
<span>      <span class="va">gs_type</span>, <span class="va">null_model</span>, <span class="va">cor_method</span>, <span class="va">aggre_method</span>, <span class="va">minGSSize</span>, <span class="va">maxGSSize</span>, <span class="va">iter_total</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Construct the full path to the folder</span></span>
<span>    <span class="va">input_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir_base</span>, <span class="va">folder_name</span><span class="op">)</span></span>
<span>    <span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="va">input_dir_base</span></span>
<span></span>
<span>    <span class="co"># Construct the save name based on the folder name</span></span>
<span>    <span class="va">save_name</span> <span class="op">&lt;-</span> <span class="va">folder_name</span></span>
<span></span>
<span>    <span class="co"># Call the job_cat function to merge the RDS files in this folder</span></span>
<span>    <span class="fu"><a href="../reference/job_cat.html">job_cat</a></span><span class="op">(</span></span>
<span>      input_dir <span class="op">=</span> <span class="va">input_dir</span>,</span>
<span>      output_dir <span class="op">=</span> <span class="va">output_dir</span>,</span>
<span>      n_rds <span class="op">=</span> <span class="va">iter_total</span> <span class="op">/</span> <span class="va">n_iter_per_job</span>,</span>
<span>      save_name <span class="op">=</span> <span class="va">save_name</span>,</span>
<span>      file_pattern <span class="op">=</span> <span class="st">"res_job_%d.rds"</span>,</span>
<span>      delete_originals <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      preserve_attributes <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      result_prefix <span class="op">=</span> <span class="st">"null_"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="loop-through-other-input-arguments">3.4. loop through other input arguments<a class="anchor" aria-label="anchor" href="#loop-through-other-input-arguments"></a>
</h3>
<p>Note!</p>
<p>For the array in bash, do not include commas in the array. For example,</p>
<p><code>aggre_methods=("mean" "median" "meanabs" "maxmean", "ks_weighted", "ks_pos_neg_sum")</code></p>
<p>Here, <code>maxmean</code> will be treated as <code>maxmean,</code> and <code>ks_weighted</code> will be treated as <code>ks_weighted,</code> respectively.</p>
<p>We can also loop through more arguments in the slurm job file:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="co">#!/bin/bash</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="co">#SBATCH --job-name=gsScore       # Job name</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="co">#SBATCH --output=gsScore.out     # Standard output log</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="co">#SBATCH --error=gsScore.err      # Standard error log</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a><span class="co">#SBATCH --time=10:00:00          # Time limit hrs:min:sec</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="co">#SBATCH --nodes=1                # Number of nodes</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a><span class="co">#SBATCH --ntasks=1               # Number of tasks</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a><span class="co">#SBATCH --mem=16G                # Memory per node</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a><span class="co">#SBATCH --array=1-1000           # Array range (adjust based on perm_total / n_perm_per_job)</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a><span class="co"># Define variables for the script</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a><span class="va">n_iter_per_job=</span>5          # <span class="ex">Number</span> of permutations per job (adjust as needed)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a><span class="va">iter_total=</span>5000           # <span class="ex">Total</span> number of permutations</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a><span class="va">cor_method=</span><span class="st">"pearson"</span>      # <span class="ex">Correlation</span> method</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a><span class="va">minGSSize=</span>20              # <span class="ex">Minimum</span> gene set size</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a><span class="va">maxGSSize=</span>200             # <span class="ex">Maximum</span> gene set size</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a><span class="co"># Define arrays of null models, gene set types, and aggregation methods</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true"></a><span class="va">null_models=(</span><span class="st">"resample_gene"</span> <span class="st">"spin_brain"</span><span class="va">)</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true"></a><span class="va">gs_types=(</span><span class="st">"SynGO"</span> <span class="st">"GO_MF"</span><span class="va">)</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true"></a><span class="va">aggre_methods=(</span><span class="st">"mean"</span> <span class="st">"median"</span> <span class="st">"meanabs"</span> <span class="st">"maxmean"</span> <span class="st">"ks_weighted"</span> <span class="st">"ks_pos_neg_sum"</span><span class="va">)</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true"></a><span class="co"># Change directory to where your R script is located</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true"></a><span class="bu">cd</span> /gpfs1/home/z/c/zcao4/BrainEnrich</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true"></a><span class="co"># Loop over gene set types, null models, and aggregation methods</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true"></a><span class="kw">for</span> <span class="ex">gs_type</span> in <span class="st">"</span><span class="va">${gs_types[@]}</span><span class="st">"</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true"></a>  <span class="kw">for</span> <span class="ex">null_model</span> in <span class="st">"</span><span class="va">${null_models[@]}</span><span class="st">"</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true"></a>    <span class="kw">for</span> <span class="ex">aggre_method</span> in <span class="st">"</span><span class="va">${aggre_methods[@]}</span><span class="st">"</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true"></a>      <span class="ex">Rscript</span> --vanilla brainscore_vacc.R <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="va">$n_iter_per_job</span> <span class="va">$iter_total</span> <span class="va">$cor_method</span> <span class="va">$aggre_method</span> <span class="va">$null_model</span> <span class="va">$gs_type</span> <span class="va">$minGSSize</span> <span class="va">$maxGSSize</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true"></a>    <span class="kw">done</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true"></a>  <span class="kw">done</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true"></a><span class="kw">done</span></span></code></pre></div>
<p>Similar way to collect the results using job_cat</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set the base output directory</span></span>
<span><span class="va">input_dir_base</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/precomputed_brainscore"</span></span>
<span></span>
<span><span class="co"># Define the parameters of the analysis</span></span>
<span><span class="va">n_iter_per_job</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># Number of iterations per job</span></span>
<span><span class="va">iter_total</span> <span class="op">&lt;-</span> <span class="fl">5000</span> <span class="co"># Total number of iterations</span></span>
<span><span class="va">cor_method</span> <span class="op">&lt;-</span> <span class="st">"pearson"</span> <span class="co"># Correlation method</span></span>
<span><span class="va">minGSSize</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># Minimum gene set size</span></span>
<span><span class="va">maxGSSize</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># Maximum gene set size</span></span>
<span></span>
<span><span class="co"># Define an array of null models, gene set types, and aggregation methods to loop through</span></span>
<span><span class="va">null_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"resample_gene"</span>, <span class="st">"spin_brain"</span><span class="op">)</span></span>
<span><span class="va">gs_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SynGO"</span>, <span class="st">"GO_MF"</span><span class="op">)</span></span>
<span><span class="va">aggre_methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ks_weighted"</span>, <span class="st">"maxmean"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through each combination of null model, gene set type, and aggregation method</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">null_model</span> <span class="kw">in</span> <span class="va">null_models</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">gs_type</span> <span class="kw">in</span> <span class="va">gs_types</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">aggre_method</span> <span class="kw">in</span> <span class="va">aggre_methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Construct the folder name based on the parameters</span></span>
<span>      <span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>        <span class="st">"%s_%s_%s_%s_%d_%d_%d"</span>,</span>
<span>        <span class="va">gs_type</span>, <span class="va">null_model</span>, <span class="va">cor_method</span>, <span class="va">aggre_method</span>, <span class="va">minGSSize</span>, <span class="va">maxGSSize</span>, <span class="va">iter_total</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Construct the full path to the folder</span></span>
<span>      <span class="va">input_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir_base</span>, <span class="va">folder_name</span><span class="op">)</span></span>
<span>      <span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="va">input_dir_base</span></span>
<span></span>
<span>      <span class="co"># Construct the save name based on the folder name</span></span>
<span>      <span class="va">save_name</span> <span class="op">&lt;-</span> <span class="va">folder_name</span></span>
<span></span>
<span>      <span class="co"># Call the job_cat function to merge the RDS files in this folder</span></span>
<span>      <span class="fu"><a href="../reference/job_cat.html">job_cat</a></span><span class="op">(</span></span>
<span>        input_dir <span class="op">=</span> <span class="va">input_dir</span>,</span>
<span>        output_dir <span class="op">=</span> <span class="va">output_dir</span>,</span>
<span>        n_rds <span class="op">=</span> <span class="va">iter_total</span> <span class="op">/</span> <span class="va">n_iter_per_job</span>,</span>
<span>        save_name <span class="op">=</span> <span class="va">save_name</span>,</span>
<span>        file_pattern <span class="op">=</span> <span class="st">"res_job_%d.rds"</span>,</span>
<span>        delete_originals <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        preserve_attributes <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        result_prefix <span class="op">=</span> <span class="st">"null_"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="setup-brainscore-lm_test-with-precomputed-null-scores">4. setup brainscore.lm_test with precomputed null scores<a class="anchor" aria-label="anchor" href="#setup-brainscore-lm_test-with-precomputed-null-scores"></a>
</h2>
<p>One advantage of precomputing null gene set scores is that you can reuse them for multiple analyses without recalculating them each time.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zh1peng.github.io/BrainEnrich/" class="external-link">BrainEnrich</a></span><span class="op">)</span></span>
<span><span class="va">data_path</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/data"</span></span>
<span><span class="va">res_path</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/res"</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">res_path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">res_path</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">null_score_dir</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/precomputed_brainscore"</span></span>
<span></span>
<span><span class="co"># Load hcp brain_data</span></span>
<span><span class="va">gene_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_geneExp.html">get_geneExp</a></span><span class="op">(</span>atlas <span class="op">=</span> <span class="st">"desikan"</span>, rdonor <span class="op">=</span> <span class="st">"r0.4"</span>, hem <span class="op">=</span> <span class="st">"L"</span><span class="op">)</span></span>
<span><span class="va">brain_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"hcp_brain_data_dk_lh.RDS"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cov_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"hcp_cov_df.RDS"</span><span class="op">)</span><span class="op">)</span> <span class="co"># Assuming covariates data is stored in cov_df.RDS</span></span>
<span><span class="va">pred_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"hcp_pred_df.RDS"</span><span class="op">)</span><span class="op">)</span> <span class="co"># Assuming predictor data is stored in pred_df.RDS</span></span>
<span></span>
<span><span class="co"># Define the parameters of the analysis</span></span>
<span><span class="va">n_iter_per_job</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># Number of iterations per job</span></span>
<span><span class="va">iter_total</span> <span class="op">&lt;-</span> <span class="fl">5000</span> <span class="co"># Total number of iterations</span></span>
<span><span class="va">cor_method</span> <span class="op">&lt;-</span> <span class="st">"pearson"</span> <span class="co"># Correlation method</span></span>
<span><span class="va">minGSSize</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># Minimum gene set size</span></span>
<span><span class="va">maxGSSize</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># Maximum gene set size</span></span>
<span></span>
<span><span class="co"># Define an array of null models, gene set types, and aggregation methods to loop through</span></span>
<span><span class="va">null_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"resample_gene"</span>, <span class="st">"spin_brain"</span><span class="op">)</span></span>
<span><span class="va">gs_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SynGO"</span><span class="op">)</span></span>
<span><span class="va">aggre_methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"median"</span>, <span class="st">"meanabs"</span>, <span class="st">"maxmean"</span>, <span class="st">"ks_weighted"</span>, <span class="st">"ks_pos_neg_sum"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Loop through each combination of null model, gene set type, and aggregation method</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">null_model</span> <span class="kw">in</span> <span class="va">null_models</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">gs_type</span> <span class="kw">in</span> <span class="va">gs_types</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">annoData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_annoData.html">get_annoData</a></span><span class="op">(</span>type <span class="op">=</span> <span class="va">gs_type</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">aggre_method</span> <span class="kw">in</span> <span class="va">aggre_methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">gs_type</span>, <span class="va">null_model</span>, <span class="va">cor_method</span>, <span class="va">aggre_method</span>, <span class="va">minGSSize</span>, <span class="va">maxGSSize</span>, <span class="va">iter_total</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Construct the folder name based on the parameters</span></span>
<span>      <span class="va">nllScoreRds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>        <span class="st">"%s/%s_%s_%s_%s_%d_%d_%d.rds"</span>,</span>
<span>        <span class="va">null_score_dir</span>, <span class="va">gs_type</span>, <span class="va">null_model</span>, <span class="va">cor_method</span>, <span class="va">aggre_method</span>, <span class="va">minGSSize</span>, <span class="va">maxGSSize</span>, <span class="va">iter_total</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">nullscore</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">nllScoreRds</span><span class="op">)</span></span>
<span></span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brainscore.lm_test.html">brainscore.lm_test</a></span><span class="op">(</span></span>
<span>        pred_df <span class="op">=</span> <span class="va">pred_df</span>,</span>
<span>        cov_df <span class="op">=</span> <span class="va">cov_df</span>,</span>
<span>        brain_data <span class="op">=</span> <span class="va">brain_data</span>,</span>
<span>        gene_data <span class="op">=</span> <span class="va">gene_data</span>,</span>
<span>        annoData <span class="op">=</span> <span class="va">annoData</span>,</span>
<span>        gsScoreList.null <span class="op">=</span> <span class="va">nullscore</span>,</span>
<span>        cor_method <span class="op">=</span> <span class="st">"pearson"</span>,</span>
<span>        aggre_method <span class="op">=</span> <span class="va">aggre_method</span>,</span>
<span>        n_cores <span class="op">=</span> <span class="fl">63</span>,</span>
<span>        minGSSize <span class="op">=</span> <span class="va">minGSSize</span>,</span>
<span>        maxGSSize <span class="op">=</span> <span class="va">maxGSSize</span>,</span>
<span>        null_model <span class="op">=</span> <span class="va">null_model</span>,</span>
<span>        n_perm <span class="op">=</span> <span class="va">iter_total</span>,</span>
<span>        pvalueCutoff <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        gsea_obj <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># return a df instead of a gsea object</span></span>
<span>        threshold_type <span class="op">=</span> <span class="st">"none"</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">res</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">res_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"res_%s_%s_%s_%s_%d_%d_%d.rds"</span>, <span class="va">gs_type</span>, <span class="va">null_model</span>, <span class="va">cor_method</span>, <span class="va">aggre_method</span>, <span class="va">minGSSize</span>, <span class="va">maxGSSize</span>, <span class="va">iter_total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>setup slurm job file to run the brainscore.lm_test Note that if setting <code>n_cores=0</code> to auto detect the number of cores, it will cause error. In the Rscript, we set <code>n_cores=63</code> to use 63 cores, which is the maximum number of cores on the node.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="co">#!/bin/bash</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="co">#SBATCH --job-name=lm              # Job name</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="co">#SBATCH --error=lm.err   </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="co">#SBATCH --out=lm.out   </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a><span class="co">#SBATCH --time=24:00:00                 # Time limit hrs:min:sec</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="co">#SBATCH --nodes=1                       # Number of nodes</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="co">#SBATCH --ntasks=64                    # Number of tasks</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a><span class="co">#SBATCH --mem=64G                       # Memory per node (increase memory if it is unexpextedly slow)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a><span class="bu">cd</span> /gpfs1/home/z/c/zcao4/BrainEnrich</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a><span class="ex">Rscript</span> --vanilla lm_tes_vacc.R</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="use-job_splitter-a-generic-function-to-split-jobs-to-do-brainscore-simulate">5. use job_splitter (a generic function to split jobs) to do brainscore.simulate<a class="anchor" aria-label="anchor" href="#use-job_splitter-a-generic-function-to-split-jobs-to-do-brainscore-simulate"></a>
</h2>
<div class="section level3">
<h3 id="prepare-the-script-for-the-job_splitter-function-1">5.1. Prepare the script for the job_splitter function<a class="anchor" aria-label="anchor" href="#prepare-the-script-for-the-job_splitter-function-1"></a>
</h3>
<p>Here, we will prepare a script for distributed computing environments, allowing large-scale permutation tests to be split across multiple compute nodes.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rscript this_script.R &lt;job_id&gt; &lt;n_iter_per_job&gt; &lt;iter_total&gt; &lt;cor_method&gt; &lt;aggre_method&gt; &lt;sim_type&gt; &lt;gs_type&gt; &lt;minGSSize&gt; &lt;maxGSSize&gt; &lt;gsScoreList.null&gt;</span></span>
<span><span class="co"># Get command-line arguments</span></span>
<span><span class="co"># this hpc function is for type1 simulation</span></span>
<span><span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span>trailingOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">job_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">n_iter_per_job</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">iter_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">cor_method</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">aggre_method</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">sim_type</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="va">gs_type</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span></span>
<span><span class="va">minGSSize</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">maxGSSize</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">gsScoreList.null</span> <span class="op">&lt;-</span> <span class="va">args</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Load your R package and any required libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zh1peng.github.io/BrainEnrich/" class="external-link">BrainEnrich</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set other parameters</span></span>
<span><span class="va">output_dir_base</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/sim_res"</span></span>
<span><span class="va">data_path</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/data"</span></span>
<span></span>
<span><span class="co"># Load hcp brain_data</span></span>
<span><span class="va">brain_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"hcp_brain_data_dk_lh.RDS"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cov_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"hcp_cov_df.RDS"</span><span class="op">)</span><span class="op">)</span> <span class="co"># Assuming covariates data is stored in cov_df.RDS</span></span>
<span><span class="va">pred_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">"hcp_pred_df.RDS"</span><span class="op">)</span><span class="op">)</span> <span class="co"># Assuming predictor data is stored in pred_df.RDS</span></span>
<span></span>
<span><span class="co"># Load additional necessary data</span></span>
<span><span class="va">gene_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_geneExp.html">get_geneExp</a></span><span class="op">(</span>atlas <span class="op">=</span> <span class="st">"desikan"</span>, rdonor <span class="op">=</span> <span class="st">"r0.4"</span>, hem <span class="op">=</span> <span class="st">"L"</span><span class="op">)</span></span>
<span><span class="va">annoData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_annoData.html">get_annoData</a></span><span class="op">(</span>type <span class="op">=</span> <span class="va">gs_type</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">sim_type</span> <span class="op">==</span> <span class="st">"spin_brain"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subset_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>perm_id <span class="op">=</span> <span class="va">perm_id_dk_lh_5000</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">subset_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">sim_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"resample_gene"</span>, <span class="st">"spin_brain"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">gsScoreList.null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">gsScoreList.null</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Update the output directory based on the input parameters</span></span>
<span><span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>  <span class="va">output_dir_base</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>    <span class="st">"%s_%s_%s_%s_%d_%d_%d"</span>,</span>
<span>    <span class="va">gs_type</span>,</span>
<span>    <span class="va">sim_type</span>,</span>
<span>    <span class="va">cor_method</span>,</span>
<span>    <span class="va">aggre_method</span>,</span>
<span>    <span class="va">minGSSize</span>,</span>
<span>    <span class="va">maxGSSize</span>,</span>
<span>    <span class="va">iter_total</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Call the job_splitter function</span></span>
<span><span class="fu"><a href="../reference/job_splitter.html">job_splitter</a></span><span class="op">(</span></span>
<span>  job_id <span class="op">=</span> <span class="va">job_id</span>,</span>
<span>  n_iter_per_job <span class="op">=</span> <span class="va">n_iter_per_job</span>,</span>
<span>  iter_total <span class="op">=</span> <span class="va">iter_total</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="va">output_dir</span>,</span>
<span>  FUN <span class="op">=</span> <span class="va">brainscore.simulate</span>,</span>
<span>  subset_vars <span class="op">=</span> <span class="va">subset_vars</span>, <span class="co"># No subset_vars required in this case</span></span>
<span>  subset_total_var <span class="op">=</span> <span class="st">"sim_n"</span>,</span>
<span>  brain_data <span class="op">=</span> <span class="va">brain_data</span>,</span>
<span>  gene_data <span class="op">=</span> <span class="va">gene_data</span>,</span>
<span>  annoData <span class="op">=</span> <span class="va">annoData</span>,</span>
<span>  pred_df <span class="op">=</span> <span class="va">pred_df</span>,</span>
<span>  cov_df <span class="op">=</span> <span class="va">cov_df</span>,</span>
<span>  cor_method <span class="op">=</span> <span class="va">cor_method</span>,</span>
<span>  aggre_method <span class="op">=</span> <span class="va">aggre_method</span>,</span>
<span>  subsample_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span>,</span>
<span>  sim_setting <span class="op">=</span> <span class="st">"type1"</span>,</span>
<span>  sim_type <span class="op">=</span> <span class="va">sim_type</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  minGSSize <span class="op">=</span> <span class="va">minGSSize</span>,</span>
<span>  maxGSSize <span class="op">=</span> <span class="va">maxGSSize</span>,</span>
<span>  n_perm <span class="op">=</span> <span class="fl">5000</span>, <span class="co"># should match gsScoreList</span></span>
<span>  gsScoreList.null <span class="op">=</span> <span class="va">gsScoreList.null</span> <span class="co"># This argument is now correctly placed at the end</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prepare-the-slurm-job-file-1">5.2. Prepare the slurm job file<a class="anchor" aria-label="anchor" href="#prepare-the-slurm-job-file-1"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="co">#!/bin/bash</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="co">#SBATCH --job-name=sim_type1    # Job name</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="co">#SBATCH --output=type1.out             # Standard output log</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a><span class="co">#SBATCH --error=type1.err              # Standard error log</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a><span class="co">#SBATCH --time=24:00:00              # Time limit hrs:min:sec</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a><span class="co">#SBATCH --nodes=1                    # Number of nodes</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a><span class="co">#SBATCH --ntasks=1                   # Number of tasks</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a><span class="co">#SBATCH --mem=24G                    # Memory per node</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a><span class="co">#SBATCH --array=1-1000               # Array range (adjust based on iter_total / n_iter_per_job)</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a><span class="co"># Define the variables</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a><span class="va">n_iter_per_job=</span>1          # <span class="ex">Number</span> of iterations per job</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a><span class="va">iter_total=</span>1000           # <span class="ex">Total</span> number of iterations</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a><span class="va">cor_method=</span><span class="st">"pearson"</span>      # <span class="ex">Correlation</span> method</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a><span class="va">minGSSize=</span>20              # <span class="ex">Minimum</span> gene set size</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a><span class="va">maxGSSize=</span>200             # <span class="ex">Maximum</span> gene set size</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a><span class="va">sim_types=(</span><span class="st">"randomize_pred"</span> <span class="st">"spin_brain"</span> <span class="st">"resample_gene"</span><span class="va">)</span>  # <span class="ex">Simulation</span> types</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a><span class="va">gs_types=(</span><span class="st">"SynGO"</span><span class="va">)</span>        # <span class="ex">Gene</span> set types</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a><span class="va">aggre_methods=(</span><span class="st">"mean"</span> <span class="st">"median"</span> <span class="st">"meanabs"</span> <span class="st">"maxmean"</span> <span class="st">"ks_weighted"</span> <span class="st">"ks_pos_neg_sum"</span><span class="va">)</span> # <span class="ex">Aggregation</span> methods</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a><span class="co"># Change to the directory where the R script is located</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a><span class="bu">cd</span> /gpfs1/home/z/c/zcao4/BrainEnrich</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a><span class="co"># Loop through each combination of gene set type, simulation type, and aggregation method</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a><span class="kw">for</span> <span class="ex">gs_type</span> in <span class="st">"</span><span class="va">${gs_types[@]}</span><span class="st">"</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>  <span class="kw">for</span> <span class="ex">sim_type</span> in <span class="st">"</span><span class="va">${sim_types[@]}</span><span class="st">"</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a>    <span class="kw">for</span> <span class="ex">aggre_method</span> in <span class="st">"</span><span class="va">${aggre_methods[@]}</span><span class="st">"</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a>      <span class="kw">if [[</span> <span class="st">"</span><span class="va">$sim_type</span><span class="st">"</span> <span class="ot">==</span> <span class="st">"randomize_pred"</span><span class="kw"> ]]</span>; <span class="kw">then</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a>        <span class="co"># Run the script without gsScoreList.null for randomize_pred</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a>        <span class="ex">Rscript</span> --vanilla brainscore_simulate_type1_vacc.R <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="va">$n_iter_per_job</span> <span class="va">$iter_total</span> <span class="va">$cor_method</span> <span class="va">$aggre_method</span> <span class="va">$sim_type</span> <span class="va">$gs_type</span> <span class="va">$minGSSize</span> <span class="va">$maxGSSize</span> <span class="st">""</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a>      <span class="kw">else</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a>        <span class="co"># Set the gsScoreList.null file path based on the current analysis parameters</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a>        <span class="va">gsScoreList_null=</span><span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/precomputed_brainscore/</span><span class="va">${gs_type}</span><span class="st">_</span><span class="va">${sim_type}</span><span class="st">_</span><span class="va">${cor_method}</span><span class="st">_</span><span class="va">${aggre_method}</span><span class="st">_</span><span class="va">${minGSSize}</span><span class="st">_</span><span class="va">${maxGSSize}</span><span class="st">_5000.rds"</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a>        </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a>        <span class="co"># Run the script with gsScoreList.null for other simulation types</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a>        <span class="ex">Rscript</span> --vanilla brainscore_simulate_type1_vacc.R <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="va">$n_iter_per_job</span> <span class="va">$iter_total</span> <span class="va">$cor_method</span> <span class="va">$aggre_method</span> <span class="va">$sim_type</span> <span class="va">$gs_type</span> <span class="va">$minGSSize</span> <span class="va">$maxGSSize</span> <span class="va">$gsScoreList_null</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a>      <span class="kw">fi</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a>    <span class="kw">done</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a>  <span class="kw">done</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true"></a><span class="kw">done</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="use-job_cat-to-collect-the-brainscore-results-from-jobs-1">5.3. Use job_cat to collect the brainscore results from jobs<a class="anchor" aria-label="anchor" href="#use-job_cat-to-collect-the-brainscore-results-from-jobs-1"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zh1peng.github.io/BrainEnrich/" class="external-link">BrainEnrich</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the base input and output directories</span></span>
<span><span class="va">input_dir_base</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/sim_res"</span></span>
<span><span class="va">output_dir_base</span> <span class="op">&lt;-</span> <span class="st">"/gpfs1/home/z/c/zcao4/BrainEnrich/sim_res"</span></span>
<span></span>
<span><span class="co"># Define the parameters of the analysis</span></span>
<span><span class="va">iter_total</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># Total number of iterations</span></span>
<span><span class="va">cor_method</span> <span class="op">&lt;-</span> <span class="st">"pearson"</span> <span class="co"># Correlation method</span></span>
<span><span class="va">aggre_methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ks_pos_neg_sum"</span>, <span class="st">"ks_weighted"</span>, <span class="st">"maxmean"</span>, <span class="st">"meanabs"</span>, <span class="st">"median"</span>, <span class="st">"mean"</span><span class="op">)</span> <span class="co"># Aggregation methods</span></span>
<span><span class="va">null_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"randomize_pred"</span>, <span class="st">"resample_gene"</span>, <span class="st">"spin_brain"</span><span class="op">)</span> <span class="co"># Null models</span></span>
<span><span class="va">gs_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SynGO"</span><span class="op">)</span> <span class="co"># Gene set types</span></span>
<span><span class="va">minGSSize</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># Minimum gene set size</span></span>
<span><span class="va">maxGSSize</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># Maximum gene set size</span></span>
<span></span>
<span><span class="co"># Loop through each combination of null model, aggregation method, and gene set type</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">null_model</span> <span class="kw">in</span> <span class="va">null_models</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">aggre_method</span> <span class="kw">in</span> <span class="va">aggre_methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">gs_type</span> <span class="kw">in</span> <span class="va">gs_types</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Construct the folder name based on the parameters</span></span>
<span>      <span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>        <span class="st">"%s_%s_%s_%s_%d_%d_%d"</span>,</span>
<span>        <span class="va">gs_type</span>, <span class="va">null_model</span>, <span class="va">cor_method</span>, <span class="va">aggre_method</span>, <span class="va">minGSSize</span>, <span class="va">maxGSSize</span>, <span class="va">iter_total</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Construct the full path to the folder</span></span>
<span>      <span class="va">input_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir_base</span>, <span class="va">folder_name</span><span class="op">)</span></span>
<span>      <span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="va">output_dir_base</span></span>
<span></span>
<span>      <span class="co"># Construct the save name based on the folder name</span></span>
<span>      <span class="va">save_name</span> <span class="op">&lt;-</span> <span class="va">folder_name</span></span>
<span></span>
<span>      <span class="co"># Call the job_cat function to merge the RDS files in this folder</span></span>
<span>      <span class="fu"><a href="../reference/job_cat.html">job_cat</a></span><span class="op">(</span></span>
<span>        input_dir <span class="op">=</span> <span class="va">input_dir</span>,</span>
<span>        output_dir <span class="op">=</span> <span class="va">output_dir</span>,</span>
<span>        n_rds <span class="op">=</span> <span class="va">iter_total</span>,</span>
<span>        save_name <span class="op">=</span> <span class="va">save_name</span>,</span>
<span>        file_pattern <span class="op">=</span> <span class="st">"res_job_%d.rds"</span>,</span>
<span>        delete_originals <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Zhipeng Cao.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
