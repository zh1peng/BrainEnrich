---
title: "Enrichment analysis of individual-level IDPs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Enrichment analysis of individual-level IDPs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, eval=TRUE}
# if (!requireNamespace("BrainEnrich", quietly=TRUE)){
#   install.packages("BrainEnrich")
# }
# if (!requireNamespace("enrichplot", quietly=TRUE)){
#   BiocManager::install("enrichplot")
# }
library(BrainEnrich)
library(dplyr)
library(enrichplot)
library(ggplot2)
```

## 1. Prepare Data for the Analysis
In this section, we will prepare the data needed for enrichment analysis. The data is simulated from the HCP dataset, and we'll be using various pre-defined gene sets from GO-MF and brain data for analysis.

### 1.1. Load sample data frame. The data is simulated from HCP data.
The data is simulated from HCP data. Let's load and inspect it.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
data(sample_df)
head(sample_df)
colnames(sample_df)
```
### 1.2. prepare brain_data for scoring
Next, we'll prepare the brain data by selecting the relevant columns and transforming the data for scoring.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
brain_data <- dplyr::select(sample_df, starts_with("L_")) %>% t()
colnames(brain_data) <- paste0("sub-", 1:ncol(brain_data))
head(brain_data)
```

### 1.3. Load gene expression data for the Analysis
We will now load gene expression data for the analysis. This data is based on a specific brain atlas (Desikan) and includes gene expression levels (correlation across donnors > 0.4) for the left hemisphere.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
gene_data <- get_geneExp(atlas = "desikan", rdonor = "r0.4", hem = "L")
str(gene_data)
```

### 1.4. Load SynGO for the Analysis
We will load GO MF terms that will be used in the enrichment analysis. This data represents gene sets associated with various molecular functions.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
annoData <- get_annoData(type = "SynGO")
geneSetList <- get_geneSetList(annoData)
length(geneSetList)
print(sprintf("Number of SynGO terms: %d", length(geneSetList)))
```

#### Filter the geneSetList (not required for the analysis)
Filtering the gene sets by size is optional and is shown here for demonstration purposes. This step is embedded in the brainenrich/brainscore function.
```{r echo=TRUE, eval=FALSE}
selected.gs <- filter_geneSetList(bg_genes = colnames(gene_data), geneSetList = geneSetList, minGSSize = 20, maxGSSize = 200)
print(sprintf("%d MF terms have gene size ranging between 20 and 200", length(selected.gs)))
```

## 2. Run the Analysis 
In this section, we will run the individual enrichment analysis using the prepared data.

### 2.1. get the row score of the brain_data (`set null_model='none'`)
We calculate the gene set scores for the brain data without using any null model.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
gsScore.raw <- brainscore(
  brain_data = brain_data,
  gene_data = gene_data,
  annoData = annoData,
  cor_method = "pearson",
  aggre_method = "mean",
  n_cores = 0,
  minGSSize = 20,
  maxGSSize = 200,
  null_model = "none"
)
str(head(gsScore.raw))
```
The gsScore.raw is a list of molecular terms. For each molecular term, you can find individual gene set scores (gsScores) and use them for further analysis, such as linear regression or correlation analysis.

### 2.2. Get the null score of the brain_data (`set null_model='spin_brain'`)
Next, we will calculate the null scores using the 'spin_brain' null model.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
gsScore.spin <- brainscore(
  brain_data = brain_data,
  gene_data = gene_data,
  annoData = annoData,
  cor_method = "pearson",
  aggre_method = "mean",
  n_cores = 0,
  minGSSize = 20,
  maxGSSize = 200,
  null_model = "spin_brain",
  n_perm = 5,
  perm_id = perm_id_dk_lh_5000
)
str(head(gsScore.spin, 5), 1)
```
The result is a list of lists. Each sublist contains null scores for the molecular terms. This is useful for permutation tests, where you compare the observed correlation with your dependent variable between empirical gsScore and null model gsScore.

### 2.3. get the null score of the resample_gene (`set null_model='resample_gene'`)
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
gsScore.resample <- brainscore(
  brain_data = brain_data,
  gene_data = gene_data,
  annoData = annoData,
  cor_method = "pearson",
  aggre_method = "mean",
  n_cores = 0,
  minGSSize = 20,
  maxGSSize = 200,
  null_model = "resample_gene",
  n_perm = 5
)
str(head(gsScore.resample, 5), 1)
```
This result is also a list of lists containing null scores for molecular terms. These null scores can be used in permutation tests or other analyses.


### 2.4. Perform linear regression between the gsScore and the brain data
We will perform linear regression tests between the gsScore and the brain data and build a null model to determine the significance.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
cov_df <- sample_df %>% dplyr::select(Age, Sex)
pred_df <- sample_df %>% dplyr::select(BMI)
res <- brainscore.lm_test(
  pred_df = pred_df,
  cov_df = cov_df,
  brain_data = brain_data,
  gene_data = gene_data,
  annoData = annoData,
  cor_method = "pearson",
  aggre_method = "mean",
  n_cores = 0,
  minGSSize = 50,
  maxGSSize = 200,
  null_model = "spin_brain",
  n_perm = 5,
  perm_id = perm_id_dk_lh_5000,
  pvalueCutoff = 0.8
)
res.df <- as.data.frame(res)
```
For demonstration purposes, we only performed 10 permutations and set minGSSize to 50. In practice, you may need to perform more permutations (e.g., 5000) for a more reliable p-value.


### 2.5. Perform linear regression between the gsScore and the brain data using precomputed null scores
As an alternative to the previous step, you can use precomputed null scores to perform linear regression tests between the gsScore and the brain data.
Generating null brain scores can be time consuming, especially when the number of permutations is high. Therefore, we recommend using precomputed null scores for the analysis.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
res1 <- brainscore.lm_test(
  pred_df = pred_df,
  cov_df = cov_df,
  brain_data = brain_data,
  gene_data = gene_data,
  annoData = annoData,
  gsScoreList.null = gsScore.spin,
  cor_method = "pearson",
  aggre_method = "mean",
  n_cores = 0,
  minGSSize = 20,
  maxGSSize = 200,
  null_model = "spin_brain",
  n_perm = 5,
  pvalueCutoff = 0.8
)
```
The attribute of the gsScoreList.null should be the same as your input of the function for these variables:
cor_method, aggre_method, minGSSize, maxGSSize, null_model, n_perm, if not, that means the gsScoreList.null is not usable for the currrent setup.

## 3. Visualization
This section covers the visualization of the results.
Note: the upsetplot, heatplot that are available for brainenrich resutls are not applicable for these results.

### 3.2. Gene-Concept Network
We will visualize the gene-concept network.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=8, fig.width=8}
geneList <- res@geneList
showCategory <- 10
showID <- res@result$ID[1:showCategory]
show.geneList <- geneList[showID]
color_palette <- colorRampPalette(c("#0197b2", "white", "orange"))(100)
breaks <- seq(-3, 3, length.out = 101)
geneList_colors <- color_palette[cut(show.geneList, breaks = breaks, labels = FALSE)]
named_colors <- setNames(geneList_colors, names(show.geneList))
cnetplot(res,
  layout = "kk",
  color.params = list(category = named_colors),
  showCategory = showCategory, cex.params = list(
    category_node = 1, gene_node = 0.75,
    category_label = 1.2, gene_label = 0.6
  ),
) + scale_color_gradientn(colors = color_palette, limits = c(-3, 3), name = "t value")
```

### 3.3. Dot Plot
We will create a dot plot to visualize the results.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=8, fig.width=8}
dotplot(res, x = "t_Value", label_format = 50, showCategory = 30) +
  xlab("GS score") + scale_fill_gradient(
    high = "#0197b2", low = "orange",
    space = "Lab", name = "p.adjusted"
  )
```
This completes the visualization section of the tutorial, where we used various plots to illustrate the results of the brain enrichment analysis.
