---
title: "Enrichment analysis of group-level IDPs"
output: rmarkdown::html_vignette
  mathjax: "default"
vignette: >
  %\VignetteIndexEntry{Enrichment analysis of group-level IDPs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This tutorial demonstrates how to perform an enrichment analysis of derived group-level statistics using the `BrainEnrich` package. We will use effect size maps of Bipolar Disorders (BD) and gene expression data to identify significant gene sets.


## 0. Load the required libraries:

```{r setup, eval=TRUE}
# if (!requireNamespace("BrainEnrich", quietly=TRUE)){
#   install.packages("BrainEnrich")
# }
# if (!requireNamespace("enrichplot", quietly=TRUE)){
#   BiocManager::install("enrichplot")
# }
library(BrainEnrich)
library(dplyr)
library(enrichplot)
library(ggplot2)
```

## 1. Prepare Data for the Analysis

### 1.1. Load brain_data (effect size maps of Bipolar Disorders)

We will load brain data that contains the effect size maps of Bipolar Disorders. This data includes case-control comparisons of regional cortical thickness.

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Load brain data from the package
data(brain_data)
# Display the structure of the brain data
str(brain_data)
```

#### Show effect size map for BD

Visualize the effect size map to understand the regional differences in cortical thickness.

```{r fig.align='center', fig.height=6, fig.width=6, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
df2plot <- brain_data %>% tibble::rownames_to_column("label")
plot_brain(df2plot,
  ats = "dk", filterby = "none", limit2show = c(-0.5, 0.5),
  what2plot = "BD", hem = "left", low = "#0197b2", mid = "white", high = "orange",
  legend2show = "Effect Size"
)
```

### 1.2. Create perm_id for the Analysis

```{r eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# read the centroid coordinates of the brain regions
data(coord_dk_lh)
perm_id_dk_lh_5000 <- rotate_parcellation(coord.l = coord_dk_lh, nrot = 5000, seed = 2024)
```

#### Here, we can load the perm_id directly from the package.

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
data(perm_id_dk_lh_5000)
str(perm_id_dk_lh_5000)
```

### 1.3. Load gene expression data for the Analysis

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
gene_data <- get_geneExp(atlas = "desikan", rdonor = "r0.4", hem = "L")
str(gene_data)
```

### 1.4. Load GO MF for the Analysis

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
annoData <- get_annoData(type = "GO_MF")
geneSetList <- get_geneSetList(annoData)
length(geneSetList)
print(sprintf("Number of MF terms: %d", length(geneSetList)))
```

#### Filter the geneSetList (optional). 
#### This step is embedded in the `brainenrich` function. Here is just to show how it is filtered.

```{r echo=TRUE, eval=FALSE}
selected.gs <- filter_geneSetList(bg_genes = colnames(gene_data), geneSetList = geneSetList, minGSSize = 20, maxGSSize = 200)
print(sprintf("%d MF terms have gene size ranging between 20 and 200", length(selected.gs)))
```

## 2. Run the Analysis 

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
res <- brainenrich(
  brain_data = brain_data,
  gene_data = gene_data,
  annoData = annoData,
  perm_id = perm_id_dk_lh_5000,
  cor_method = "pearson",
  aggre_method = "mean",
  null_model = "spin_brain",
  n_perm = 5000,
  n_cores = 0,
  minGSSize = 20,
  maxGSSize = 200,
  pvalueCutoff = 1,
  threshold_type = "sd",
  threshold = 1
)
```

## 3. Visualize the Results

The res is a gseaResult object that is commonly used in clusterProfiler and DOSE packages. This means that we can use some existing functions to visualize the results.

### 3.1. Upset Plot

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=6, fig.width=10}
upsetplot(res, top = 15)
```

### 3.2. Gene-Concept Network

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=8, fig.width=8}
geneList <- res@geneList
cnetplot(res,
  layout = "kk", color_category = "#a6a6a6", foldChange = geneList,
  # color.params = list(foldChange = geneList),
  showCategory = 10, cex.params = list(
    category_node = 1, gene_node = 0.75,
    category_label = 1.2, gene_label = 0.6
  ),
) + scale_color_gradient2(
  midpoint = 0, low = "#0197b2", mid = "white", high = "orange",
  space = "Lab", limits = c(-1, 1), name = "Association"
)
```

### 3.3. Dot Plot

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=8, fig.width=8}
dotplot(res, x = "gsScore", label_format = 50, showCategory = 30) +
  xlab("GS score") + scale_fill_gradient(
    high = "#0197b2", low = "orange",
    space = "Lab", name = "p.adjusted"
  )
```

### 3.4. Heatplot 

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=6, fig.width=12}
heatplot(res, foldChange = geneList, label_format = 50, showCategory = 10) +
  scale_fill_gradient2(
    midpoint = 0, low = "#0197b2", mid = "white", high = "orange",
    space = "Lab", limits = c(-1, 1), name = "Association"
  )
```
### 3.5. Tree plot based on term similarity
This requires GOSemSim and org.Hs.eg.db packages.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=10, fig.width=10}
d <- GOSemSim::godata(annoDb = "org.Hs.eg.db", ont = "MF", keytype = "SYMBOL", computeIC = FALSE) # computeIC=FALSE when use Wang method
res <- pairwise_termsim(res, method = "Wang", semData = d)
treeplot(res,
  showCategory = 30,
  cex_category = 0.9,
  nCluster = 5,
  nWords = 2,
  color = "p.adjust",
  offset = rel(2)
) + theme(legend.position = c(0.95, 0.46))
```


```{r, echo=FALSE,eval=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Render me
rmd_path <- "E:/xhmhc/BrainEnrich/vignettes"
rmarkdown::render(
  input = file.path(rmd_path, "brainenrich_demo.rmd"),
  output_format = "html_document",
  output_file = file.path(rmd_path, "brainenrich_demo.html")
)
```
