---
title: "Enrichment analysis of derived group-level statistics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{brainenrich}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(BrainEnrich)
# if (!requireNamespace("enrichplot", quietly=TRUE)){
# BiocManager::install("enrichplot")}
library(enrichplot)
```

## 1. Prepare Data for the Analysis
### 1.1. Load brain_data (effect size maps of Bipolar Disorders)
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# load brain data from the pacakge
# it is the case control comprisons of regional cortical thickness between Bipolar Disorders and controls
data(brain_data)
str(brain_data)
```
#### show effect size map for BD
```{r fig.align='center', fig.height=8, fig.width=8, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
df2plot=brain_data %>% tibble::rownames_to_column('label')
plot_brain(df2plot,ats='dk',filterby = 'none',limit2show=c(-0.5,0.5), 
        what2plot = 'BD',hem='left',low='#0197b2',mid='white',high='orange',
        legend2show = 'Effect Size')
```


### 1.2. Create perm_id for the Analysis
```{r eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# read the centroid coordinates of the brain regions
data(coord_dk_lh)
perm_id_dk_lh_5000=rotate_parcellation(coord.l=coord_dk_lh, nrot=5000, seed=2024)
```
#### Here, we can load the perm_id directly from the package.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
data(perm_id_dk_lh_5000)
str(perm_id_dk_lh_5000)
```

### 1.3. Load gene expression data for the Analysis
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
gene_data=get_geneExp(atlas='desikan', rdonor='r0.4',hem='L')
str(gene_data)
```

### 1.4. Load GO MF for the Analysis
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
annoData=get_annoData(type='GO_MF')
geneSetList=get_geneSetList(annoData)
length(geneSetList)
print(sprintf('Number of MF terms: %d',length(geneSetList)))
```

#### Filter the geneSetList (optional). 
#### This step is embedded in the `brainenrich` function. Here is just to show how it is filtered.
```{r echo=TRUE, eval=FALSE}
selected.gs=filter_geneSetList(bg_genes=colnames(gene_data), geneSetList=geneSetList, minGSSize=20, maxGSSize=200)
print(sprintf('%d MF terms have gene size ranging between 20 and 200',length(selected.gs)))
```
## 2. Run the Analysis 
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
res=brainenrich(brain_data=brain_data, 
                    gene_data=gene_data, 
                    annoData = annoData, 
                    perm_id=perm_id_dk_lh_5000, 
                    cor_method = 'pearson',
                    aggre_method = 'mean',
                    null_model = 'spin_brain',
                    n_perm=5000, 
                    n_cores=0,
                    minGSSize = 20, 
                    maxGSSize = 200,
                    pvalueCutoff = 1,
                    threshold_type = 'sd',
                    threshold = 1)
```

## 3. Visualize the Results
The res is a gseaResult object that is commonly used in clusterProfiler and DOSE packages.
This means that we can use some existing functions to visualize the results.
### 3.1. Upset Plot
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=6, fig.width=10}
upsetplot(res, top=10)
```
### 3.2. Gene-Concept Network
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=8, fig.width=8}
geneList=res@geneList
cnetplot(res, layout='kk', color_category='#a6a6a6', foldChange=geneList,
          # color.params = list(foldChange = geneList),
          showCategory =5, cex.params = list(category_node=1, gene_node=0.75,
                                            category_label=1.2, gene_label=0.6),
          )+scale_color_gradient2(midpoint=0,low='#0197b2',mid='white',high='orange',
                         space ="Lab" ,limits = c(-1,1), name='Association')
```

### 3.3. Dot Plot
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=6, fig.width=8}
dotplot(res,x='gsScore',label_format=50, showCategory=10)+
  xlab('GS score')+scale_fill_gradient(high='#0197b2',low='orange',
                         space ="Lab" , name='p.adjusted')

```

### 3.4. Heatplot 
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=6, fig.width=10}
heatplot(res,foldChange=geneList,label_format=50)
```

